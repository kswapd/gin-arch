webpackJsonp([9],{"8Fep":function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=a("Xxa5"),n=a.n(r),s=a("BO1k"),i=a.n(s),o=a("exGp"),c=a.n(o),u=a("Dd8w"),l=a.n(u),d=a("NYxO"),p={data:function(){return{activeNames:[],instanceList:[],isSpare:!1,serviceRoutes:[],btnLoading:!1,serviceName:"",instanceIds:[],hostData:{},route:{id:"",uri:"",version:"",versionOptions:[],routeValue:"",routeOptions:[],serverRoute:[],predicateParam:[{name:"",args:[]}]}}},computed:l()({},Object(d.d)({predicateOptions:function(e){return e.core.predicateOptions}})),methods:l()({},Object(d.b)("core",["custom","deploy","getPredicates","instancesStatus","coreVersionFind","checkVersion"]),{back:function(){this.$parent.isAddRouter=!1},getVersion:function(){var e=this;return c()(n.a.mark(function t(){var a,r;return n.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return a=e,t.next=3,a.coreVersionFind(a);case 3:if(t.t0=t.sent,t.t0){t.next=6;break}t.t0={};case 6:"0000"===(r=t.t0).code?a.route.versionOptions=r.data||[]:a.$message.error(r&&r.message||"获取版本失败");case 8:case"end":return t.stop()}},t,e)}))()},verification:function(){var e=this;return c()(n.a.mark(function t(){var a;return n.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if((a=e).route.version){t.next=3;break}return t.abrupt("return");case 3:return a.btnLoading=!0,t.next=6,a.checkVersion(a);case 6:if(t.t0=t.sent,t.t0){t.next=9;break}t.t0=!1;case 9:t.t0||(a.$message.error("选择版本不可用！"),a.route.version=""),a.btnLoading=!1;case 12:case"end":return t.stop()}},t,e)}))()},predicateChange:function(e,t){var a=this.predicateOptions.filter(function(t){return t.name===e});t.args=a[0].args},release:function(){var e=this;return c()(n.a.mark(function t(){var a;return n.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:(a=e).$refs.routeForm.validate(function(){var t=c()(n.a.mark(function t(r){var s,o,u,l,d,p,v,m,f,g,h,b,x,k,y,w,_,L,$;return n.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!r){t.next=77;break}for(a.btnLoading=!0,s=a.commonFunc.deepCopy(a.route.serverRoute[0])||{},o=s.filterParam,u=s.predicateParam,l=s.order,d=!0,p=!1,v=void 0,t.prev=6,m=i()(a.serviceRoutes);!(d=(f=m.next()).done);d=!0)(g=f.value).filterParam=o,g.order=l-1,g.predicateParam=u.concat(a.route.predicateParam);t.next=14;break;case 10:t.prev=10,t.t0=t.catch(6),p=!0,v=t.t0;case 14:t.prev=14,t.prev=15,!d&&m.return&&m.return();case 17:if(t.prev=17,!p){t.next=20;break}throw v;case 20:return t.finish(17);case 21:return t.finish(14);case 22:h=!0,b=!1,x=void 0,t.prev=25,k=i()(a.instanceIds);case 27:if(h=(y=k.next()).done){t.next=40;break}return w=y.value,a.instanceId=w,t.next=32,a.instancesStatus(a);case 32:if((_=t.sent)&&"0000"===_.code){t.next=37;break}return a.btnLoading=!1,a.$message.error(_&&_.message||"服务下线失败"),t.abrupt("return");case 37:h=!0,t.next=27;break;case 40:t.next=46;break;case 42:t.prev=42,t.t1=t.catch(25),b=!0,x=t.t1;case 46:t.prev=46,t.prev=47,!h&&k.return&&k.return();case 49:if(t.prev=49,!b){t.next=52;break}throw x;case 52:return t.finish(49);case 53:return t.finish(46);case 54:return t.next=56,a.custom(a);case 56:if(!(L=t.sent)||"0000"!==L.code){t.next=61;break}a.$message.success("路由设置完成"),t.next=64;break;case 61:return a.$message.error(L&&L.message||"路由设置失败"),a.btnLoading=!1,t.abrupt("return");case 64:return t.next=66,a.deploy(a);case 66:if(!($=t.sent)||"0000"!==$.code){t.next=71;break}a.$message.success("部署完成"),t.next=74;break;case 71:return a.btnLoading=!1,a.$message.error($&&$.message||"部署失败"),t.abrupt("return");case 74:setTimeout(c()(n.a.mark(function t(){var r;return n.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.instancesStatus(a);case 2:if((r=e.sent)&&"0000"===r.code){e.next=7;break}return a.btnLoading=!1,a.$message.error(r&&r.message||"服务下线失败"),e.abrupt("return",!1);case 7:return e.next=9,a.$parent.getAllNodesByService(a.$parent);case 9:a.$parent.isAddRouter=!1,a.$parent.change(),a.instanceIds=[];case 12:case"end":return e.stop()}},t,e)})),3e4),t.next=79;break;case 77:return a.activeNames=["predicate"],t.abrupt("return",!1);case 79:case"end":return t.stop()}},t,e,[[6,10,14,22],[15,,17,21],[25,42,46,54],[47,,49,53]])}));return function(e){return t.apply(this,arguments)}}());case 2:case"end":return t.stop()}},t,e)}))()},addPredicate:function(e){e.push({name:"",args:[]})},deleteFilter:function(e,t,a){a&&1===e.length?this.$message.error("谓词至少添加一个"):e.splice(t,1)},rules:function(e){var t=[{required:!0,message:"version"===e?"请选择版本":"请输入Value",trigger:["blur","change"]}];switch(e){case"Path":t.push({pattern:/^(([0-9a-zA-Z-*/]+))+$/,message:"请输入正确路径格式",trigger:["blur","change"]});break;case"Host":t.push({pattern:/^((25[0-5]|2[0-4]\d|((1\d{2})|([1-9]?\d)))\.){3}(25[0-5]|2[0-4]\d|((1\d{2})|([1-9]?\d)))$/,message:"请输入正确IP格式",trigger:["blur","change"]})}return t},routeChange:function(){var e=this;e.route.routeValue&&(e.route.serverRoute=e.commonFunc.deepCopy(e.route.routeOptions.filter(function(t){return t.id===e.route.routeValue}))||[])}}),created:function(){var e=this;e.$store.state.core.predicateOptions=[],e.instanceList=this.$store.state.core.instanceList||[],e.hostData=e.$store.state.core.hostData||[],e.route.routeOptions=e.hostData[0].route||[];var t=[],a=[],r=!0,n=!1,s=void 0;try{for(var o,c=i()(e.instanceList);!(r=(o=c.next()).done);r=!0){var u=o.value;t.push("Gray_Release_"+u.instanceId),e.instanceIds.push(""+u.instanceId),a.push(u.uri),e.serviceRoutes.push({id:"Gray_Release_"+u.instanceId,uri:u.uri,order:200,predicateParam:[]}),e.route.predicateParam=e.instanceList[0].route[0]&&e.commonFunc.deepCopy(e.instanceList[0].route[0].predicateParam.filter(function(e){return"Weight"!==e.name}))||[{name:"",args:[]}]}}catch(e){n=!0,s=e}finally{try{!r&&c.return&&c.return()}finally{if(n)throw s}}e.route.id=t.join("; "),e.route.uri=a.join("; "),e.serviceName=e.$parent.serviceName,e.getPredicates(),e.getVersion()}},v={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"content"},[a("el-dialog",{attrs:{title:"设置路由信息",visible:e.$parent.isAddRouter,top:"5vh",width:"50%",center:""},on:{"update:visible":function(t){e.$set(e.$parent,"isAddRouter",t)}}},[a("el-form",{key:e.routeIndex,ref:"routeForm",staticClass:"route-box",attrs:{model:e.route,"label-width":"165px","label-position":"left",size:"small","hide-required-asterisk":"true"}},[a("el-form-item",{attrs:{label:"选定修改的路由名称：",prop:"id",rules:{required:!0,message:"",trigger:[]}}},[a("el-input",{attrs:{disabled:"",title:e.route.id},model:{value:e.route.id,callback:function(t){e.$set(e.route,"id",t)},expression:"route.id"}})],1),e._v(" "),a("el-form-item",{attrs:{label:"选定修改的URI：",prop:"uri",rules:{required:!0,message:"",trigger:[]}}},[a("el-input",{attrs:{disabled:"",title:e.route.uri},model:{value:e.route.uri,callback:function(t){e.$set(e.route,"uri",t)},expression:"route.uri"}})],1),e._v(" "),a("el-form-item",{attrs:{label:"版本：",prop:"version",rules:e.rules("version")}},[a("el-select",{attrs:{placeholder:"请选择版本",clearable:""},on:{change:e.verification},model:{value:e.route.version,callback:function(t){e.$set(e.route,"version",t)},expression:"route.version"}},e._l(e.route.versionOptions,function(e,t){return a("el-option",{key:t,attrs:{label:e.versionNo,value:e.versionNo}})}))],1),e._v(" "),a("el-form-item",{attrs:{label:"路由规则：",prop:"routeValue",rules:e.rules("route")}},[a("el-select",{attrs:{placeholder:"请选择版本",clearable:""},on:{change:e.routeChange},model:{value:e.route.routeValue,callback:function(t){e.$set(e.route,"routeValue",t)},expression:"route.routeValue"}},e._l(e.route.routeOptions,function(e,t){return a("el-option",{key:t,attrs:{label:e.id,value:e.id}})}))],1),e._v(" "),a("el-collapse",{staticClass:"mb-20 ml-10",model:{value:e.activeNames,callback:function(t){e.activeNames=t},expression:"activeNames"}},[a("el-collapse-item",{attrs:{title:"谓词",name:"predicate"}},[e._l(e.route.predicateParam,function(t,r){return a("el-form-item",{directives:[{name:"show",rawName:"v-show",value:"Weight"!==t.name,expression:"predicate.name !== 'Weight'"}],key:r,attrs:{"label-width":"0",prop:"predicateParam."+r+".name",rules:{required:!0,message:"请选择谓词类型",trigger:["blur","change"]}}},[a("el-select",{staticClass:"mb-15",on:{change:function(a){e.predicateChange(a,t)}},model:{value:t.name,callback:function(a){e.$set(t,"name",a)},expression:"predicate.name"}},e._l(e.predicateOptions,function(e){return a("el-option",{key:e.name,attrs:{label:e.comment,value:e.name}})})),e._v(" "),a("el-button",{staticClass:"btn-text-red",attrs:{type:"text",icon:"el-icon-delete"},on:{click:function(t){e.deleteFilter(e.route.predicateParam,r,"predicate")}}},[e._v("删除")]),e._v(" "),e._l(t.args,function(n,s){return a("div",{key:s},[a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"Key：","label-width":"60px"}},[a("el-input",{attrs:{disabled:""},model:{value:n.name,callback:function(t){e.$set(n,"name",t)},expression:"arg.name"}})],1)],1),e._v(" "),a("el-col",{attrs:{span:12}},[a("el-form-item",{attrs:{label:"Value：",prop:"predicateParam."+r+".args."+s+".value","label-width":"60px",rules:e.rules(t.name)}},["date"===n.type?a("el-date-picker",{attrs:{type:"datetime",placeholder:n.placeholder,"value-format":"timestamp","default-time":"12:00:00"},model:{value:n.value,callback:function(t){e.$set(n,"value",t)},expression:"arg.value"}}):a("el-input",{attrs:{placeholder:n.placeholder},model:{value:n.value,callback:function(t){e.$set(n,"value",t)},expression:"arg.value"}}),e._v(" "),a("p",{staticClass:"form-tips"},[e._v("* "+e._s(n.eg))])],1)],1)],1)],1)})],2)}),e._v(" "),a("div",{staticClass:"text-center"},[a("el-button",{attrs:{type:"text",size:"small",icon:"el-icon-plus"},on:{click:function(t){e.addPredicate(e.route.predicateParam)}}},[e._v("添加谓词")])],1)],2)],1)],1),e._v(" "),a("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{attrs:{type:"primary",loading:e.btnLoading,size:"small"},on:{click:e.release}},[e._v("灰度发布")]),e._v(" "),a("el-button",{attrs:{disabled:e.btnLoading,size:"small"},on:{click:e.back}},[e._v("关闭")])],1)],1)],1)},staticRenderFns:[]};var m=a("VU/8")(p,v,!1,function(e){a("gacC")},"data-v-e8a46564",null).exports,f={data:function(){return{dialogVisible:!1}},props:{active:Number,default:0},methods:{}},g={render:function(){var e=this.$createElement,t=this._self._c||e;return t("div",[t("div",{staticClass:"state-content"},[t("el-row",{attrs:{gutter:20}},[t("el-col",{attrs:{span:24}},[t("el-steps",{attrs:{space:200,active:this.active,"finish-status":"success","align-center":""}},[t("el-step",{attrs:{title:"初始状态",description:""}}),this._v(" "),t("el-step",{attrs:{title:"已下线",description:""}}),this._v(" "),t("el-step",{attrs:{title:"已部署",description:""}}),this._v(" "),t("el-step",{attrs:{title:"测试中",description:""}}),this._v(" "),t("el-step",{attrs:{title:"已上线",description:""}}),this._v(" "),t("el-step",{attrs:{title:"批次灰度结束",description:""}})],1)],1)],1)],1)])},staticRenderFns:[]};var h={components:{routerMessage:m,releaseState:a("VU/8")(f,g,!1,function(e){a("PqUF")},"data-v-583ad357",null).exports},data:function(){return{serviceName:"",serviceOptions:[],instanceList:[],allNodeList:[],nodeList:[],instanceId:"",instanceIds:[],runInstanceIds:[],nodeData:[],stage:null,scene:null,isAddRouter:!1,serviceRouteTitle:"",isLoading:!1,isSpareBnt:!0,numInstance:0,ip:[],isSpare:!1}},methods:l()({},Object(d.b)("core",["getServices","getAllServices","getAllNodesByService","deploy","custom","instancesStatus","upInstancesStatus","deleteRouteData"]),{change:function(e){var t=this;return c()(n.a.mark(function a(){var r;return n.a.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:(r=t).$store.state.core.grayStatusCode=0,r.scene&&r.scene.clear(),r.instanceList=[],r.serviceName&&(r.isLoading=!0,r.$axios.all([r.getServices(r),r.getAllNodesByService(r)]).then(t.$axios.spread(function(t,a){if(t&&"0000"===t.code)if(a&&"0000"===a.code){var n=t&&t.data.length&&t.data[0].instance||[];r.allNodeList=n;var s=a&&a.data||[];r.numInstance=n.length||0;var o=!0,c=!1,u=void 0;try{for(var l,d=i()(n);!(o=(l=d.next()).done);o=!0){var p=l.value,v=!0,m=!1,f=void 0;try{for(var g,h=i()(s);!(v=(g=h.next()).done);v=!0){var b=g.value;p.host===b.ip&&(p.version=b.versionNo||"",p.isGray=b.isGray)}}catch(e){m=!0,f=e}finally{try{!v&&h.return&&h.return()}finally{if(m)throw f}}}}catch(e){c=!0,u=e}finally{try{!o&&d.return&&d.return()}finally{if(c)throw u}}n.filter(function(e){return"false"===e.isGray}).length>0&&n.filter(function(e){return"true"===e.isGray}).length>0?r.isSpareBnt=!1:r.isSpareBnt=!0,r.nodeData=n,r.$store.state.core.hostData=t.data||[],r.drawCanvas(t.data,r.stage,e)}else r.$message.error(a&&t.message||"获取版本失败");else r.$message.error(t&&t.message||"获取应用失败")}))),r.isLoading=!1;case 6:case"end":return a.stop()}},a,t)}))()},spare:function(){var e=this;return c()(n.a.mark(function t(){var a,r,s,o,c,u,l,d,p,v,m,f,g,h,b,x,k,y,w,_,L,$,I,C,O,N,S,R,P,z,F,V,T,D,A,E,G,J,U,B,W,j,q,Z,M,H,Y,X,K,Q;return n.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:for((a=e).isLoading=!0,a.isSpare=!0,r=[],a.instanceIds=[],a.runInstanceIds=[],r=a.nodeData.filter(function(e){return"false"===e.isGray}),a.ip=[],s=!0,o=!1,c=void 0,t.prev=11,u=i()(r);!(s=(l=u.next()).done);s=!0)d=l.value,a.ip.push(d.host);t.next=19;break;case 15:t.prev=15,t.t0=t.catch(11),o=!0,c=t.t0;case 19:t.prev=19,t.prev=20,!s&&u.return&&u.return();case 22:if(t.prev=22,!o){t.next=25;break}throw c;case 25:return t.finish(22);case 26:return t.finish(19);case 27:for(p=a.allNodeList.filter(function(e){return-1!==a.ip.indexOf(e.host)}),v=a.allNodeList.filter(function(e){return-1===a.ip.indexOf(e.host)}),m=!0,f=!1,g=void 0,t.prev=32,h=i()(v);!(m=(b=h.next()).done);m=!0)x=b.value,a.runInstanceIds.push(x.instanceId);t.next=40;break;case 36:t.prev=36,t.t1=t.catch(32),f=!0,g=t.t1;case 40:t.prev=40,t.prev=41,!m&&h.return&&h.return();case 43:if(t.prev=43,!f){t.next=46;break}throw g;case 46:return t.finish(43);case 47:return t.finish(40);case 48:k=!0,y=!1,w=void 0,t.prev=51,_=i()(p);case 53:if(k=(L=_.next()).done){t.next=74;break}$=L.value,I={order:"200"},a.instanceIds.push(""+$.instanceId),t.t2=n.a.keys($);case 58:if((t.t3=t.t2()).done){t.next=70;break}C=t.t3.value,t.t4=C,t.next="serviceId"===t.t4?63:"uri"===t.t4?65:67;break;case 63:return I[C]=""+$[C],t.abrupt("break",68);case 65:return I[C]=$[C],t.abrupt("break",68);case 67:return t.abrupt("break",68);case 68:t.next=58;break;case 70:a.nodeList.push(a.instanceIds);case 71:k=!0,t.next=53;break;case 74:t.next=80;break;case 76:t.prev=76,t.t5=t.catch(51),y=!0,w=t.t5;case 80:t.prev=80,t.prev=81,!k&&_.return&&_.return();case 83:if(t.prev=83,!y){t.next=86;break}throw w;case 86:return t.finish(83);case 87:return t.finish(80);case 88:return t.next=90,a.upInstancesStatus({that:a,type:""});case 90:if((O=t.sent)&&"0000"===O.code){t.next=98;break}return a.btnLoading=!1,a.$message.error(O&&O.message||"服务上线失败"),a.isLoading=!1,t.abrupt("return");case 98:a.$message.success("已部署节点上线成功");case 99:N=!0,S=!1,R=void 0,t.prev=102,P=i()(a.instanceIds);case 104:if(N=(z=P.next()).done){t.next=121;break}return F=z.value,a.instanceId=F,t.next=109,a.instancesStatus(a);case 109:if((V=t.sent)&&"0000"===V.code){t.next=117;break}return a.btnLoading=!1,a.$message.error(V&&V.message||"服务下线失败"),a.isLoading=!1,t.abrupt("return");case 117:a.$message.success("余量节点下线成功");case 118:N=!0,t.next=104;break;case 121:t.next=127;break;case 123:t.prev=123,t.t6=t.catch(102),S=!0,R=t.t6;case 127:t.prev=127,t.prev=128,!N&&P.return&&P.return();case 130:if(t.prev=130,!S){t.next=133;break}throw R;case 133:return t.finish(130);case 134:return t.finish(127);case 135:return a.instanceId="",t.next=138,a.deploy(a);case 138:if((T=t.sent)&&"0000"===T.code){t.next=146;break}return a.btnLoading=!1,a.$message.error(T&&T.message||"部署失败"),a.isLoading=!1,t.abrupt("return");case 146:a.$message.success("余量部署完成");case 147:return t.next=149,a.upInstancesStatus({that:a,type:"gray"});case 149:if((D=t.sent)&&"0000"===D.code){t.next=155;break}return a.btnLoading=!1,a.$message.error(D&&D.message||"余量服务上线失败"),a.isLoading=!1,t.abrupt("return");case 155:return t.next=157,a.getServices(a);case 157:if((A=t.sent)&&"0000"===A.code){t.next=161;break}return a.$message.error(A&&A.message||"获取节点信息失败"),t.abrupt("return");case 161:for(E=A.data&&A.data.length&&A.data[0].instance||[],G=[],J=!0,U=!1,B=void 0,t.prev=166,W=i()(E);!(J=(j=W.next()).done);J=!0)q=j.value,G=G.concat(q.route);t.next=174;break;case 170:t.prev=170,t.t7=t.catch(166),U=!0,B=t.t7;case 174:t.prev=174,t.prev=175,!J&&W.return&&W.return();case 177:if(t.prev=177,!U){t.next=180;break}throw B;case 180:return t.finish(177);case 181:return t.finish(174);case 182:for(Z=[],M=!0,H=!1,Y=void 0,t.prev=186,X=i()(G);!(M=(K=X.next()).done);M=!0)Q=K.value,Z.push(a.deleteRouteData(Q.id));t.next=194;break;case 190:t.prev=190,t.t8=t.catch(186),H=!0,Y=t.t8;case 194:t.prev=194,t.prev=195,!M&&X.return&&X.return();case 197:if(t.prev=197,!H){t.next=200;break}throw Y;case 200:return t.finish(197);case 201:return t.finish(194);case 202:return t.next=204,a.$axios.all(Z).then(a.$axios.spread(function(e){e&&"0000"===e.code?a.$message.success("清除路由规则完成"):a.$message.error(e.message||"清除路由规则失败")}));case 204:a.change(),a.isLoading=!1;case 206:case"end":return t.stop()}},t,e,[[11,15,19,27],[20,,22,26],[32,36,40,48],[41,,43,47],[51,76,80,88],[81,,83,87],[102,123,127,135],[128,,130,134],[166,170,174,182],[175,,177,181],[186,190,194,202],[195,,197,201]])}))()},setCanvasSize:function(){var e=this.$refs.topology,t=document.getElementById("content");e.width=t.offsetWidth,e.height=document.documentElement.clientHeight-260},drawCanvas:function(e,t,a){var r=this,n=[],s=[];r.scene=new JTopo.Scene(t),r.scene.alpha=0,e.map(function(e){s=s.concat(e.instance)}),e.forEach(function(e,t){var a=280*(e.instance.length+1)/2;n.push({service:r.addNode(a,278,"app.png",e.service_name,e)}),n[t].instance=[],"[object Array]"===Object.prototype.toString.call(e.instance)&&e.instance.length>0&&e.instance.forEach(function(a,s){n[t].instance.push(r.addNode(280*(s+1)-16,600,"node-up.png",a.host+" V"+a.version,a,a.route,a.limiter)),r.addLink(n[t].service,n[t].instance[s],"brokenLine","152,152,152",e.route,e.limiter)})}),r.stage.centerAndZoom();var i=Math.round(1e4/r.commonFunc.detectZoom());t.zoomIn(i/100)},handler:function(e){2===e.button&&$(".contextmenu").css({top:e.pageY-130,left:e.pageX-290}).show()},addLink:function(e,t,a,r){arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5&&void 0!==arguments[5]&&arguments[5];var n=void 0;return"dottedLine"===a?(n=e.x-2===t.x?new JTopo.Link(e,t):new JTopo.FoldLink(e,t)).dashedPattern=5:"brokenLine"===a?(n=new JTopo.FlexionalLink(e,t)).offsetGap=123.5:n=new JTopo.Link(e,t),n.direction="vertical",n.strokeColor=r,this.scene.add(n),n},addNode:function(e,t,a,r,n,s,o){var c=this,u=new JTopo.Node;if(u.setImage("../../../static/images/img/"+a,!0),u.fillStyle="255,255,0",u.fontColor="0,0,0",u.font="16px 微软雅黑",u.textPosition="Bottom_Center",u.textOffsetY=0,u.setLocation(e,t),u._name=r,u.text=r,u.dragable=!0,n&&n.uri){if("false"===n.isGray)switch(n.status){case"DOWN":u.setImage("../../../static/images/img/node-down.png",!0);break;case"OUT_OF_SERVICE":u.setImage("../../../static/images/img/node-stop.png",!0);break;default:u.setImage("../../../static/images/img/node-up.png",!0)}else switch(n.status){case"DOWN":u.setImage("../../../static/images/img/node-down-run.png",!0);break;case"OUT_OF_SERVICE":u.setImage("../../../static/images/img/node-stop-run.png",!0);break;default:u.setImage("../../../static/images/img/node-up-run.png",!0)}u.instance=n}return u.click(function(e){if(!n||!n.service_name){if(n.isChecked)switch(n.isChecked=!1,c.instanceList.splice(c.instanceList.findIndex(function(e){return e.instanceId===n.instanceId}),1),n.status){case"DOWN":u.setImage("../../../static/images/img/node-down.png",!0);break;case"OUT_OF_SERVICE":u.setImage("../../../static/images/img/node-stop.png",!0);break;default:u.setImage("../../../static/images/img/node-up.png",!0)}else{if(c.nodeData.filter(function(e){return"false"===e.isGray}).length<=1)return void c.$message({showClose:!0,message:"剩余最后一个节点，请选择余量发布！",type:"warning"});if("true"===n.isGray)return void c.$message({showClose:!0,message:"不能操作正在发布的服务",type:"warning"});if(c.instanceList.length+1===c.nodeData.filter(function(e){return"false"===e.isGray}).length)return void c.$message({showClose:!0,message:"不能同时选择全部节点",type:"warning"});n.isChecked=!0,c.instanceList.push(c.commonFunc.deepCopy(n));var t=[],a=!0,r=!1,s=void 0;try{for(var o,l=i()(c.instanceList);!(a=(o=l.next()).done);a=!0){var d=o.value;t.push(d.version),0!==t.indexOf(d.version)&&c.$message({showClose:!0,message:"选中节点版本不一致，请注意!"})}}catch(e){r=!0,s=e}finally{try{!a&&l.return&&l.return()}finally{if(r)throw s}}switch(n.status){case"DOWN":u.setImage("../../../static/images/img/node-down-checked.png",!0);break;case"OUT_OF_SERVICE":u.setImage("../../../static/images/img/node-stop-checked.png",!0);break;default:u.setImage("../../../static/images/img/node-up-checked.png",!0)}}c.$store.state.core.instanceList=c.instanceList}}),this.scene.add(u),u},centerShow:function(){this.stage.centerAndZoom();var e=Math.round(1e4/this.commonFunc.detectZoom());this.stage.zoomIn(e/100)},fullScreen:function(){this.commonFunc.runPrefixMethod(this.stage.canvas,"RequestFullScreen")},zoomOut:function(){this.stage.zoomOut()},zoomIn:function(){this.stage.zoomIn()},exportCanvas:function(){var e=this.$refs.topology,t=document.body.clientWidth-16,a=document.body.clientHeight-16,r=e.toDataURL("image/png");window.open("about:blank","image from canvas").document.write("<img width='"+t+"' height='"+a+"' src='"+r+"' alt='from canvas'/>")},searchNode:function(){var e=this.searchNodeText,t=this.stage.childs[0].childs.filter(function(e){return e instanceof JTopo.Node});if((t=t.filter(function(t){return null!=t.text&&-1!=t.text.indexOf(e)})).length>0){var a=t[0];a.selected=!0;var r=a.getCenterLocation();this.stage.setCenter(r.x,r.y),function e(t,a){0!=a?(t.selected=!t.selected,setTimeout(function(){e(t,a-1)},300)):t.selected=!1}(a,6)}},routeOpen:function(){this.isAddRouter=!0}}),mounted:function(){var e=this;return c()(n.a.mark(function t(){var a,r,s;return n.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:(a=e).setCanvasSize(),r=a.$refs.topology,s=new JTopo.Stage(r),a.stage=s,s.wheelZoom=.95;case 6:case"end":return t.stop()}},t,e)}))()},created:function(){var e=this;return c()(n.a.mark(function t(){var a,r;return n.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return(a=e).isLoading=!0,t.next=4,a.getAllServices(a);case 4:(r=t.sent)&&"0000"===r.code?a.serviceOptions=r.data||[]:a.$message.error(r.message||"查询所有服务失败"),a.isLoading=!1;case 7:case"end":return t.stop()}},t,e)}))()}},b={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{ref:"grayLevel",attrs:{id:"grayLevel"}},[a("div",{staticClass:"button-group",attrs:{id:"content"}},[a("span",{staticClass:"route-name"},[e._v(e._s(e.$route.meta.title))]),e._v(" "),a("el-button-group",[a("el-button",{staticClass:"add-btn",attrs:{type:"warning",size:"small",icon:"el-icon-setting",disabled:!e.instanceList.length,loading:e.isLoading},on:{click:e.routeOpen}},[e._v("设置路由")]),e._v(" "),a("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"余量发布，将灰度发布剩下所有上轮没有灰度的节点",placement:"bottom-end"}},[a("el-button",{staticClass:"add-btn",attrs:{type:"success",size:"small",icon:"el-icon-share",disabled:e.isSpareBnt,loading:e.isLoading},on:{click:e.spare}},[e._v("余量发布")])],1)],1),e._v(" "),a("span",{staticClass:"select-label"},[e._v("应用场景:")]),e._v(" "),a("el-select",{attrs:{size:"small",disabled:e.isAddRouter||e.ischeckState||e.isLoading,clearable:"",placeholder:"请选择应用场景"},on:{change:function(t){e.change()}},model:{value:e.serviceName,callback:function(t){e.serviceName=t},expression:"serviceName"}},e._l(e.serviceOptions,function(e){return a("el-option",{key:e,attrs:{label:e,value:e}})}))],1),e._v(" "),a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.isLoading,expression:"isLoading"}]},[a("el-row",{attrs:{gutter:0}},[a("el-col",{attrs:{span:18}},[a("div",[a("el-button-group",[a("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.centerShow}},[e._v("居中显示")]),e._v(" "),a("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.fullScreen}},[e._v("全屏显示")]),e._v(" "),a("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.zoomOut}},[e._v("放大")]),e._v(" "),a("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.zoomIn}},[e._v("缩小")])],1),e._v(" "),a("el-input",{staticClass:"ml-20",staticStyle:{width:"180px"},attrs:{id:"J_name",size:"small",placeholder:"服务或实例名称"},nativeOn:{keyup:function(t){return"button"in t||13===t.keyCode?e.searchNode(t):null}},model:{value:e.searchNodeText,callback:function(t){e.searchNodeText=t},expression:"searchNodeText"}}),e._v(" "),a("el-button",{attrs:{id:"J_search",type:"warning",size:"small"},on:{click:e.searchNode}},[e._v("查询")]),e._v(" "),a("el-button",{attrs:{type:"info",size:"small"},on:{click:e.exportCanvas}},[e._v("导出PNG")])],1)]),e._v(" "),a("el-button",{staticClass:"refresh",attrs:{size:"mini",type:"text",title:"刷新节点信息",icon:"el-icon-refresh"},on:{click:function(t){e.change()}}}),e._v(" "),a("div",{staticStyle:{clear:"both"}})],1),e._v(" "),a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:24}},[a("div",[a("canvas",{ref:"topology",staticClass:"my-canvas"})])])],1)],1),e._v(" "),e.isAddRouter?a("router-message"):e._e()],1)},staticRenderFns:[]};var x=a("VU/8")(h,b,!1,function(e){a("eRkh")},"data-v-1f4effec",null);t.default=x.exports},PqUF:function(e,t){},eRkh:function(e,t){},gacC:function(e,t){}});