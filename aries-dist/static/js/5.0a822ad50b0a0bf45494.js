webpackJsonp([5],{DzCA:function(e,t,o){"use strict";o.d(t,"a",function(){return d});var n=o("pFYg"),i=o.n(n),a=o("BO1k"),r=o.n(a),s=o("woOf"),l=o.n(s),c=o("hi7O"),d={data:function(){return{wholeConfig:{drag:!1,nodeWidth:250,nodeHeight:40,nodeFont:"13px 微软雅黑"},defaultScene:{version:"0.4.8",frames:500,wheelZoom:.95,childs:[{elementType:"scene",backgroundColor:"255,255,255",mode:"edit",paintAll:!1,areaSelect:!0,translate:!0,translateX:0,translateY:0,lastTranslatedX:"undefined",lastTranslatedY:"undefined",alpha:0,visible:!0,scaleX:1,scaleY:1,childs:[]}]},defaultNode:{elementType:"node",visible:!0,alpha:1,rotate:0,scaleX:1,scaleY:1,strokeColor:"22,124,255",fillColor:"22,124,255",shadow:!1,shadowColor:"rgba(0,0,0,0.5)",shadowOffsetX:3,shadowOffsetY:6,transformAble:!0,zIndex:3,dragable:!0,selected:!1,showSelected:!0,isMouseOver:!1,font:"12px Consolas",fontColor:"black",textPosition:"Middle_Center",textOffsetX:0,textOffsetY:-2,borderRadius:null}}},methods:{initTopology:function(e,t){var o=this;if(e.forEach(function(e){var t=l()({},o.defaultNode);t.JOB_ID=e.JOB_ID,t.nodeType=e.JOB_TYPE,t.JOB_NAME=e.JOB_NAME,t._id=e.JOB_ID,t.y=e.top,t.x=e.left,t.width=e.width,t.height=e.height,t.text=e.JOB_ID,t.info=e,o.defaultScene.childs[0].childs.push(t)}),e){c.a.loadTopology(this.defaultScene,1,t);var n={};c.a.scene.childs.filter(function(e){return e instanceof JTopo.Node}).forEach(function(e){var t="GP"===e.nodeType?"/static/images/batchRun/init-group.png":"/static/images/batchRun/init.png";e.setImage(t),n[e._id]=e});var i=!0,a=!1,s=void 0;try{for(var d,u=r()(t);!(i=(d=u.next()).done);i=!0){var f=d.value,h=void 0;"sl"===f.type?(h=new JTopo.Link(n[f.from],n[f.to])).type="line":"foh"===f.type||"fov"===f.type?((h=new JTopo.FoldLink(n[f.from],n[f.to])).lineType="foldLine",h.direction="foh"===f.type?"horizontal":"vertiacl"):"flh"===f.type||"flv"===f.type?((h=new JTopo.FlexionalLink(n[f.from],n[f.to])).lineType="flexLine",h.direction="flh"===f.type?"horizontal":"vertiacl"):"cu"===f.type?(h=new JTopo.CurveLink(n[f.from],n[f.to])).lineType="curveLine":"lr"===f.type&&((h=new JTopo.FlexionalLink(n[f.from],n[f.to])).lineType="flexLine",h.direction="horizontal",h.offsetGap=(Math.abs(n[f.from].x-n[f.to].x)-n[f.from].width)/2),h.arrowsRadius=5,h._id=f.lineId,c.a.scene.add(h)}}catch(e){a=!0,s=e}finally{try{!i&&u.return&&u.return()}finally{if(a)throw s}}}else c.a.loadTopology()},setCanvasSize:function(){var e=this.$refs[this.domId];e.width="canvas-wrapper"===this.domId?document.getElementById("content").offsetWidth:.82*document.documentElement.clientWidth,e.height="canvas-wrapper"===this.domId?document.documentElement.clientHeight-255:document.documentElement.clientHeight-260},centerShow:function(){this.stage.centerAndZoom()},fullScreen:function(){this.runPrefixMethod(this.stage.canvas,"RequestFullScreen")},runPrefixMethod:function(e,t){var o=null;["webkit","moz","ms","o",""].forEach(function(n){if(!o){""===n&&(t=t.slice(0,1).toLowerCase()+t.slice(1));var a=i()(e[n+t]);a+""!="undefined"&&(o="function"===a?e[n+t]():e[n+t])}})},zoomOut:function(){this.stage.zoomOut()},zoomIn:function(){this.stage.zoomIn()},exportCanvas:function(){this.stage.saveImageInfo()},searchNode:function(){var e=this.searchNodeText,t=this.stage.childs[0].childs.filter(function(e){return e instanceof JTopo.Node});if((t=t.filter(function(t){return void 0!==t.stepinfo&&void 0!==t.stepinfo.name&&-1!=t.stepinfo.name.indexOf(e)})).length>0){var o=t[0];o.selected=!0;!function e(t,o){0!=o?(t.selected=!t.selected,setTimeout(function(){e(t,o-1)},300)):t.selected=!1}(o,10)}}}}},H1Pf:function(e,t){},TY2X:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o("BO1k"),i=o.n(n),a=o("Xxa5"),r=o.n(a),s=o("gRE1"),l=o.n(s),c=o("exGp"),d=o.n(c),u={name:"runCanvas",mixins:[o("DzCA").a],props:{groupId:String,domId:{type:String,default:"canvas-wrapper"}},data:function(){return{scene:null,stage:null,quoteVisible:!1,isError:!1,stepRunId:null,runStatus:{N:"init",P:"run",F:"fail",S:"success",A:"skip",M:"skip"},timer:null,jobGroupId:null,topInfo:{},axiosUrl:"/batch/getBatchStatus",errorMsg:"",isGroup:!0}},mounted:function(){var e=this;return d()(r.a.mark(function t(){var o,n,i,a,s,c,d,u,f;return r.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=void 0,(o=e).groupId?(o.axiosUrl="/batch/showJobGroupRun",o.isGroup=!1,n=document.getElementById("group-canvas")):n=document.getElementById("canvas-wrapper"),i=new JTopo.Stage(n),e.stage=i,i.wheelZoom=1.05,e.setCanvasSize(),t.next=9,o.getData(o);case 9:a=t.sent,s=a.nodes,c=a.lines,d=a.batchStatus,u=l()(s),f=l()(c),e.topInfo=d,e.drawCanvas(i,u,f),e.getNewData();case 18:case"end":return t.stop()}},t,e)}))()},methods:{drawCanvas:function(e,t,o){var n=this;n.scene=new JTopo.Scene(e);var a={},r=!0,s=!1,l=void 0;try{for(var c,d=i()(t);!(r=(c=d.next()).done);r=!0){var u=c.value,f=n.addNode(Number(u.left),Number(u.top),Number(u.width),Number(u.height),"",u.JOB_ID,u);a[u.JOB_ID]=f}}catch(e){s=!0,l=e}finally{try{!r&&d.return&&d.return()}finally{if(s)throw l}}var h=!0,p=!1,g=void 0;try{for(var m,v=i()(o);!(h=(m=v.next()).done);h=!0){var N=m.value;n.addLink(a[N.from],a[N.to],"dottedLine",N.lineId,N)}}catch(e){p=!0,g=e}finally{try{!h&&v.return&&v.return()}finally{if(p)throw g}}setTimeout(function(){n.stage.centerAndZoom()},100)},addNode:function(e,t,o,n,i,a,r){var s=this,l=void 0,c=void 0,d=["F","P","S","A","M"].indexOf(r.JOB_STATUS)<0?"init":s.runStatus[r.JOB_STATUS];r.FAIL_CNT>0&&(d="fail");var u="GP"===r.JOB_TYPE?"/static/images/batchRun/"+d+"-group.png":"/static/images/batchRun/"+d+".png",f=new JTopo.Node;return f.setImage(u),f.setBound(e,t,o,n),f._name=a,f._id=r.nodeId,f.text=r.name,f.textPosition="Middle_Center",f.textOffsetY=-2,f.fontColor="50,50,50",f.stepinfo=r,this.scene.add(f),f.mousedown(function(e){l=e.x,c=e.y}),f.mouseup(function(e){Math.sqrt((l-e.x)*(l-e.x)+(c-e.y)*(c-e.y))<7&&0===e.button&&("GP"===f.stepinfo.JOB_TYPE?(s.jobGroupId=f.stepinfo.JOB_ID,s.quoteVisible=!0):s.$axios({method:"post",url:"/batch/getErrorMsg",params:{appGroup:s.$route.query.applicationGroup,zkUrl:s.$route.query.zk,JOB_ID:f.stepinfo.JOB_ID,legalPersonCode:"DEFAULT"}}).then(function(e){e&&""!==e&&(s.isError=!0,s.errorMsg=e)}))}),f},addLink:function(e,t,o,n,i){if(void 0!==e&&void 0!==t){var a=void 0;return"sl"===i.type?(a=new JTopo.Link(e,t)).type="line":"foh"===i.type||"fov"===i.type?((a=new JTopo.FoldLink(e,t)).lineType="foldLine",a.direction="foh"===i.type?"horizontal":"vertiacl"):"flh"===i.type||"flv"===i.type?((a=new JTopo.FlexionalLink(e,t)).lineType="flexLine",a.direction="flh"===i.type?"horizontal":"vertiacl"):"cu"===i.type?(a=new JTopo.CurveLink(e,t)).lineType="curveLine":"lr"===i.type&&((a=new JTopo.FlexionalLink(e,t)).lineType="flexLine",a.direction="horizontal",a.offsetGap=(Math.abs(e.x-t.x)-t.width)/2),a.arrowsRadius=5,a.lineInfo=i,a._id=n,a.lineWidth=1,this.scene.add(a),a}},addTextNode:function(e){var t=e.width,o=e.height,n=e.x,i=e.y,a=e.stepinfo.stepRunEntity,r=a.currentCount,s=a.splitCount,l=a.stepType,c=new JTopo.TextNode;return c.setSize(t/2,o),c.setLocation(n+t+2,i+o/3),0===s&&"SD"===l&&(c.visible=!1),c.relationId=e.nodeId||e._id,c.text="("+r+"/"+s+")",c.fontColor="50,50,50",c.font="10px 微软雅黑",c.showSelected=!1,c},getNewData:function(){var e=this,t=this;null!==t.timer&&clearInterval(t.timer),t.timer=setInterval(function(){t.$axios({method:"post",url:e.axiosUrl,params:{batchClass:e.$route.query.batchClass,appGroup:e.$route.query.applicationGroup,zkUrl:e.$route.query.zk,jobGroupId:e.groupId,legalPersonCode:"DEFAULT"}}).then(function(e){t.getNodeTimer(l()(e.body.nodes))})},1e3)},getNodeTimer:function(e){var t=this,o=t.stage.childs[0];if(o.childs){var n=o.childs.filter(function(e){return e instanceof JTopo.Node});o.childs.filter(function(e){return e instanceof JTopo.TextNode});e.forEach(function(e){n.forEach(function(o){var n=o.stepinfo,i=e,a=void 0!==n?n.JOB_ID:"";if(i.JOB_ID===a){var r=["F","P","S","A","M"].indexOf(i.JOB_STATUS)<0?"init":t.runStatus[i.JOB_STATUS];i.FAIL_CNT>0&&(r="fail"),"GP"===e.JOB_TYPE?n.JOB_STATUS!==i.JOB_STATUS&&o.setImage("/static/images/batchRun/"+r+"-group.png"):n.JOB_STATUS!==i.JOB_STATUS&&o.setImage("/static/images/batchRun/"+r+".png"),o.text=e.name,o.stepinfo=e}})})}},control:function(e){var t=this,o="start"===e?"/batch/startBatch":"/batch/stopBatch",n="start"===e?"启动":"停止";this.$confirm("确认要"+n+"吗?","提示",{cancelButtonText:"取消",confirmButtonText:"确定",type:"warning"}).then(function(){t.$axios({method:"post",url:o,params:{batchClass:t.$route.query.batchClass,appGroup:t.$route.query.applicationGroup,zkUrl:t.$route.query.zk,legalPersonCode:"DEFAULT"}}).then(function(e){e.success?t.$message.success("操作成功"):t.$message.error("操作失败")})}).catch(function(){t.$message.error("操作失败")})},getData:function(){return this.$axios({method:"post",url:this.axiosUrl,params:{batchClass:this.$route.query.batchClass,appGroup:this.$route.query.applicationGroup,zkUrl:this.$route.query.zk,jobGroupId:this.groupId,legalPersonCode:"DEFAULT"}}).then(function(e){return e.body})}},beforeDestroy:function(){clearInterval(this.timer),this.timer=null}},f={render:function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{staticClass:"job-canvas",attrs:{id:"content"}},[e.isGroup?o("div",{staticClass:"button-group"},[o("el-row",{staticStyle:{"font-size":"14px",float:"left","line-height":"30px"}},[o("span",{staticClass:"bacth-title",staticStyle:{color:"#a7a7a7"}},[e._v("批处理： ")]),e._v(e._s(e.$route.query.batchClass)+"\n      "),o("span",{staticClass:"bacth-title",staticStyle:{color:"#a7a7a7","margin-left":"8px"}},[e._v("批处理日期： ")]),e._v(e._s(e.topInfo.RUN_DATE)+"\n      "),o("span",{staticClass:"bacth-title",staticStyle:{color:"#a7a7a7","margin-left":"8px"}},[e._v("批处理开始时间： ")]),e._v(e._s(e.topInfo.START_TIME)+"\n      "),o("span",{staticClass:"bacth-title",staticStyle:{color:"#a7a7a7","margin-left":"8px"}},[e._v("批处理结束时间： ")]),e._v(e._s(e.topInfo.END_TIME||"无")+"\n    ")])],1):e._e(),e._v(" "),o("div",{staticStyle:{"margin-bottom":"5px"}},[e.isGroup?o("el-button",{attrs:{type:"success",size:"small"},on:{click:function(t){e.control("start")}}},[e._v("启动")]):e._e(),e._v(" "),e.isGroup?o("el-button",{attrs:{type:"warning",size:"small"},on:{click:function(t){e.control("stop")}}},[e._v("停止")]):e._e(),e._v(" "),o("el-button-group",{staticStyle:{margin:"0 15px","vertical-align":"bottom"}},[o("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.centerShow}},[e._v("居中显示")]),e._v(" "),o("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.fullScreen}},[e._v("全屏显示")]),e._v(" "),o("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.zoomOut}},[e._v("放大")]),e._v(" "),o("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.zoomIn}},[e._v("缩小")])],1),e._v(" "),o("el-input",{staticStyle:{width:"180px"},attrs:{size:"small",placeholder:"服务或实例名称"},nativeOn:{keyup:function(t){return"button"in t||13===t.keyCode?e.searchNode(t):null}},model:{value:e.searchNodeText,callback:function(t){e.searchNodeText=t},expression:"searchNodeText"}}),e._v(" "),o("el-button",{attrs:{type:"warning",size:"small"},on:{click:e.searchNode}},[e._v("查询")]),e._v(" "),o("el-button",{attrs:{type:"info",size:"small"},on:{click:e.exportCanvas}},[e._v("导出PNG")]),e._v(" "),e._m(0)],1),e._v(" "),o("div",{staticClass:"canvas-wrapper"},[o("canvas",{ref:e.domId,staticClass:"job-step-canvas",attrs:{id:e.domId}})]),e._v(" "),o("el-dialog",{staticClass:"canvas-in-dialog",attrs:{"close-on-press-escape":!1,top:"3vh",title:"JOB GROUP",visible:e.quoteVisible,width:"85%"},on:{"update:visible":function(t){e.quoteVisible=t}}},[e.quoteVisible?o("run-canvas",{attrs:{"dom-id":"group-canvas","group-id":e.jobGroupId}}):e._e()],1),e._v(" "),o("el-dialog",{attrs:{title:"错误信息",visible:e.isError,width:"60%","append-to-body":""},on:{"update:visible":function(t){e.isError=t}}},[o("div",[e._v(e._s(e.errorMsg))])])],1)},staticRenderFns:[function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("ul",{staticClass:"status-tool"},[o("li",{staticClass:"recent-item recent-item-new"},[e._v("新建")]),e._v(" "),o("li",{staticClass:"recent-item recent-item-running"},[e._v("运行中")]),e._v(" "),o("li",{staticClass:"recent-item recent-item-skip"},[e._v("跳过")]),e._v(" "),o("li",{staticClass:"recent-item recent-item-success"},[e._v("完成")]),e._v(" "),o("li",{staticClass:"recent-item recent-item-fail"},[e._v("失败")])])}]};var h=o("VU/8")(u,f,!1,function(e){o("H1Pf")},null,null);t.default=h.exports},TmV0:function(e,t,o){o("fZOM"),e.exports=o("FeBl").Object.values},fZOM:function(e,t,o){var n=o("kM2E"),i=o("mbce")(!1);n(n.S,"Object",{values:function(e){return i(e)}})},gRE1:function(e,t,o){e.exports={default:o("TmV0"),__esModule:!0}},hi7O:function(e,t,o){"use strict";var n=o("pFYg"),i=o.n(n);function a(){}function r(){this.config={stageFrames:500,defaultScal:.95,eagleEyeVsibleDefault:!1,nodeAlpha:1,nodeStrokeColor:"22,124,255",nodeFillColor:"22,124,255",nodeShadow:!1,nodeShadowColor:"rgba(0,0,0,0.5)",nodeFont:"12px Consolas",nodeFontColor:"black",nodeDefaultWidth:125,nodeDefaultHeight:20,nodeBorderColor:"black",nodeBorderRadius:30,nodeRotateValue:.5,nodeScale:.2,linkAlpha:1,linkStrokeColor:"22,124,255",linkFillColor:"22,124,255",linkShadow:!1,linkShadowColor:"rgba(0,0,0,0.5)",linkFont:"12px Consolas",linkFontColor:"black",linkArrowsRadius:8,linkDefaultWidth:2,linkOffsetGap:40,linkDirection:"horizontal",containerAlpha:1,containerStrokeColor:"22,124,255",containerFillColor:"22,124,255",containerShadow:!1,containerShadowColor:"rgba(0,0,0,0.5)",containerFont:"12px Consolas",containerFontColor:"black",containerBorderColor:"black",containerBorderRadius:30},this.layout={},this.stage=null,this.scene=null,this.stageMode="normal",this.lineType="line",this.currentNode=null,this.currentLink=null,this.nodeMenu=$("#node-menu"),this.lineMenu=$("#line-menu"),this.mainMenu=$("#main-menu"),this.layoutMenu=$("#layout-menu"),this.nodeTextPosMenu=$("#node-text-pos-menu"),this.groupMangeMenu=$("#group-mange-menu"),this.groupAlignMenu=$("#group-align-menu"),this.alignGroup=$("#align-group"),this.containerMangeMenu=$("#container-mange-menu"),this.clickNode=null,a.call(this)}a.prototype.saveTopology=function(e){s.mainMenu.hide();for(var t=s.utils.getContainers(),o=0;o<t.length;o++){for(var n=[],i=t[o].childs,a=0;a<i.length;a++)i[a]instanceof JTopo.Node&&n.push(i[a].nodeId);t[o].childNodes=n.join(",")}this.scene=s.scene;var r=this.scene.childs.filter(function(e){return e instanceof JTopo.Node}),l=this.scene.childs.filter(function(e){return e instanceof JTopo.Link});return{steps:r.map(function(e){return{stepId:e.stepId,appId:e.appId,nodePosType:e.nodeType,nodeId:e._id,topPos:e.y.toFixed(1),leftPos:e.x.toFixed(1),width:e.width.toFixed(1),height:e.height.toFixed(1)}}),lines:l.map(function(e){return{lineId:e._id,fromNodeId:e.nodeA._id,toNodeId:e.nodeZ._id}})}},a.prototype.resetTopology=function(e){s.stageMode="edit",this.replaceStage(e)},a.prototype.loadTopology=function(e,t,o,n){if(t){var i=e;s.init(t,n,i,"",o)}else{s.init(t,n,"-1","",o)}},a.prototype.loadTopologyByJson=function(e,t){try{JTopo.replaceStageWithJson(e),s.stage&&s.scene&&s.scene.childs&&s.scene.childs.length>0&&s.stage.centerAndZoom()}catch(e){JTopo.replaceStageWithJson({version:"0.4.8",wheelZoom:.95,width:972,height:569,id:"ST172.19.105.52015100809430700001",childs:[{elementType:"scene",id:"S172.19.105.52015100809430700002",translateX:-121.82,translateY:306.72,scaleX:1.26,scaleY:1.26,childs:[]}]}),s.stage&&s.scene&&s.scene.childs&&s.scene.childs.length>0&&s.stage.centerAndZoom()}},a.prototype.deleteAllNodes=function(){s.stage.childs.forEach(function(e){e.clear()}),s.beginNode=null,s.link=null},r.prototype=new a,r.prototype.initMenus=function(){var e=this;e.nodeMenu.on("click",function(t){var o=$.trim($(t.target).text());switch("删除节点"===o?s.utils.deleteSelectedNodes():"复制节点(Shift+C)"===o?e.utils.cloneSelectedNodes():"撤销(Shift+Z)"===o?e.utils.cancleNodeAction():"重做(Shift+R)"===o?e.utils.reMakeNodeAction():s.utils.saveNodeInitState(),o){case"放大(Shift+)":e.utils.scalingBig(),e.utils.saveNodeNewState();break;case"缩小(Shift-)":e.utils.scalingSmall(),e.utils.saveNodeNewState();break;case"顺时针旋转(Shift+U)":e.utils.rotateAdd(),e.utils.saveNodeNewState();break;case"逆时针旋转(Shift+I)":e.utils.rotateSub(),e.utils.saveNodeNewState();break;case"节点文字":return}$(this).hide()}),e.nodeMenu.on("mouseover",function(t){var o=$.trim($(t.target).text()),n=parseInt(this.style.left)+$(document.getElementById("change-node-text-pos")).width();n+2*e.nodeTextPosMenu.width()>=e.stage.width&&(n-=e.nodeTextPosMenu.width()+e.nodeMenu.width()),"文字位置"===o?(e.layoutMenu.hide(),e.nodeTextPosMenu.css({top:parseInt(this.style.top)+$(document.getElementById("change-node-text-pos")).height(),left:n}).show()):"应用布局"===o?(e.nodeTextPosMenu.hide(),e.layoutMenu.css({top:parseInt(this.style.top),left:n}).show()):(e.layoutMenu.hide(),e.nodeTextPosMenu.hide())}),e.nodeTextPosMenu.on("click",function(t){var o=$.trim($(t.target).text());if(e.currentNode&&e.currentNode instanceof JTopo.Node){switch(e.utils.saveNodeInitState(),o){case"顶部居左":e.currentNode.textPosition="Top_Left",e.utils.saveNodeNewState();break;case"顶部居中":e.currentNode.textPosition="Top_Center",e.utils.saveNodeNewState();break;case"顶部居右":e.currentNode.textPosition="Top_Right",e.utils.saveNodeNewState();break;case"中间居左":e.currentNode.textPosition="Middle_Left",e.utils.saveNodeNewState();break;case"居中":e.currentNode.textPosition="Middle_Center",e.utils.saveNodeNewState();break;case"中间居右":e.currentNode.textPosition="Middle_Right",e.utils.saveNodeNewState();break;case"底部居左":e.currentNode.textPosition="Bottom_Left",e.utils.saveNodeNewState();break;case"底部居中":e.currentNode.textPosition="Bottom_Center",e.utils.saveNodeNewState();break;case"底部居右":e.currentNode.textPosition="Bottom_Right",e.utils.saveNodeNewState()}$("div[id$='-menu']").hide()}}),e.lineMenu.on("click",function(e){switch($(this).hide(),$.trim($(e.target).text())){case"连线设置":break;case"删除连线":s.utils.deleteLine()}}),e.mainMenu.on("click",function(e){$(this).hide()}),e.groupMangeMenu.on("click",function(t){var o=e.currentNode,n=e.utils.getSelectedNodes();if(o&&n&&0!==n.length){$(this).hide();var i=$.trim($(t.target).text());n.forEach(function(e){if(e._id===o._id)return!0;"水平对齐"===i?e.y=o.y:"垂直对齐"===i&&(e.x=o.x)})}}),e.groupMangeMenu.on("mouseover",function(t){if("对齐方式"===$.trim($(t.target).text())){var o=parseInt(this.style.left)+$(document.getElementById("align-group")).width();o+2*e.alignGroup.width()>=e.stage.width&&(o-=e.alignGroup.width()+e.groupMangeMenu.width()),e.groupAlignMenu.css({top:parseInt(this.style.top)+$(document.getElementById("align-group")).height(),left:o}).show()}else e.groupAlignMenu.hide()}),e.containerMangeMenu.on("click",function(t){var o=s.currentNode;o instanceof JTopo.Container&&($(this).hide(),"拆分"===$.trim($(t.target).text())&&(e.utils.toSplit(),e.utils.deleteNode(o)))}),e.layoutMenu.on("click",function(t){s.currentNode.layout={},$("div[id$='-menu']").hide();var o=$.trim($(t.target).text());"取消布局"===o?s.currentNode.layout.on=!1:"分组布局"===o?(s.currentNode.layout.on=!0,s.currentNode.layout.type="auto"):"树形布局"===o?(s.currentNode.layout.on=!0,s.currentNode.layout.type="tree",s.currentNode.layout.direction="bottom",s.currentNode.layout.width=80,s.currentNode.layout.height=100,JTopo.layout.layoutNode(e.scene,e.currentNode,!0)):"圆形布局"===o&&(s.currentNode.layout.on=!0,s.currentNode.layout.type="circle",s.currentNode.layout.radius=200,JTopo.layout.layoutNode(e.scene,e.currentNode,!0))})},r.prototype.replaceStage=function(e){},r.prototype.init=function(e,t,o,n){if(o){this.topologyGuid=e;var i=document.getElementById("define-canvas");i.width=.95*(document.documentElement.clientWidth-305),i.height=document.documentElement.clientHeight-190,"-1"===o?(this.stage=new JTopo.Stage(i),this.scene=new JTopo.Scene(this.stage)):(this.stage=JTopo.createStageFromJson(o,i),this.scene=this.stage.childs[0]),this.stage.frames=this.config.stageFrames,this.stage.wheelZoom=this.config.defaultScal,this.stage.eagleEye.visible=this.config.eagleEyeVsibleDefault,this.stage.mode=this.stageMode,this.scene.background="/static/images/batchRun/bg_edit.png",this.tempNodeA=new JTopo.Node("tempA"),this.tempNodeA.setSize(1,1),this.tempNodeZ=new JTopo.Node("tempZ"),this.tempNodeZ.setSize(1,1),this.tempNodeL=new JTopo.Node,this.tempNodeL.setSize(1,1),this.oldLink=null,this.beginNode=null,this.link=null,this.mousex=null,this.mousey=null,this.newLink=null;var a=this;this.initMenus(),this.scene.mouseover(function(e){if(null!=e.target&&e.target instanceof JTopo.Node)$("#node-name").html(e.target.text),$("#current-time").html((new Date).toLocaleString()),$(".link-tooltip").css("display","none"),$(".node-tooltip").css({display:"block",cursor:"pointer"});else if(null!=e.target&&e.target instanceof JTopo.Link&&e.target.linkTooltip&&"edit"!==s.stageMode){$(".link-tooltip span").html(e.target.linkTooltip);var t=e.layerY?e.layerY:e.offsetY,o=e.layerX?e.layerX:e.offsetX;o+$(".link-tooltip").width()>=a.stage.width&&(o-=$(".link-tooltip").width()),t+$(".link-tooltip").height()>=a.stage.height&&(t-=$(".link-tooltip").height()),$(".node-tooltip").css("display","none"),$(".link-tooltip").css({display:"block","margin-top":t,"margin-left":o,cursor:"pointer"})}else $("#node-name").html("（鼠标悬浮节点查看）"),$("#current-time").html("（鼠标悬浮节点查看）")}),this.scene.mouseout(function(e){}),this.scene.click(function(e){if(e.target)if(a.currentNode=e.target,null!=e.target&&e.target instanceof JTopo.Node&&e.target.nodeTooltip&&"edit"!==s.stageMode){var t=a.currentNode.nodeParams;t&&t.jumpRoute&&window.open(t.jumpRoute)}else $(".node-tooltip").css("display","none");else $(".node-tooltip").css("display","none")}),this.scene.dbclick(function(e){e.target&&(a.currentNode=e.target,null!=e.target&&(e.target,JTopo.Node))}),this.scene.mousedown(function(e){e.target&&e.target instanceof JTopo.Node&&(a.mousex=e.target.x,a.mousey=e.target.y),!a.link||a.isSelectedMode||null!=e.target&&e.target!==a.beginNode&&e.target!==a.link||this.remove(a.link)}),this.scene.mouseup(function(e){if(e.target&&e.target instanceof JTopo.Node?a.currentNode=e.target:e.target&&e.target instanceof JTopo.Link&&(a.currentLink=e.target),e.target&&e.target instanceof JTopo.Node&&e.target.layout&&e.target.layout.on&&e.target.layout.type&&"auto"!==e.target.layout.type&&JTopo.layout.layoutNode(this,e.target,!0,e),2===e.button){$("div[id$='-menu']").hide();var t=e.layerY?e.layerY:e.offsetY,o=e.layerX?e.layerX:e.offsetX;if(a.xInCanvas=o,a.yInCanvas=t,e.target)if(e.target instanceof JTopo.Node){var n=a.utils.getSelectedNodes();n&&n.length>1?(o+a.groupMangeMenu.width()>=a.stage.width&&(o-=a.groupMangeMenu.width()),t+a.groupMangeMenu.height()>=a.stage.height&&(t-=a.groupMangeMenu.height()),$("#group-mange-menu").css({top:t,left:o}).show()):(o+a.nodeMenu.width()>=a.stage.width&&(o-=a.nodeMenu.width()),t+a.nodeMenu.height()>=a.stage.height&&(t-=a.nodeMenu.height()),a.nodeMenu.css({top:t+40,left:o+100}).show())}else e.target instanceof JTopo.Link?a.lineMenu.css({top:(e.layerY?e.layerY:e.offsetY)+30,left:(e.layerX?e.layerX:e.offsetX)+100}).show():e.target instanceof JTopo.Container&&a.containerMangeMenu.css({top:e.layerY?e.layerY:e.offsetY,left:e.layerX?e.layerX:e.offsetX}).show();else o+a.mainMenu.width()>=a.stage.width&&(o-=a.mainMenu.width()),t+a.mainMenu.height()>=a.stage.height&&(t-=a.mainMenu.height()),a.mainMenu.css({top:t+40,left:o+100}).show()}else if(1===e.button);else if(0===e.button)if(a.newLink=null,null!=e.target&&e.target instanceof JTopo.Node&&!a.isSelectedMode&&"edit"!==s.stageMode&&"linkShadow"!==e.target.type){if(Math.sqrt((a.mousex-e.target.x)*(a.mousex-e.target.x)+(a.mousey-e.target.y)*(a.mousey-e.target.y))>7)return;if(null==a.beginNode)a.beginNode=e.target,"line"===a.lineType?(a.link=new JTopo.Link(a.tempNodeA,a.tempNodeZ),a.link.lineType="line"):"foldLine"===a.lineType?(a.link=new JTopo.FoldLink(a.tempNodeA,a.tempNodeZ),a.link.lineType="foldLine",a.link.direction=a.config.linkDirection):"flexLine"===a.lineType?(a.link=new JTopo.FlexionalLink(a.tempNodeA,a.tempNodeZ),a.link.direction=a.config.linkDirection,a.link.lineType="flexLine"):"curveLine"===a.lineType&&(a.link=new JTopo.CurveLink(a.tempNodeA,a.tempNodeZ),a.link.lineType="curveLine"),a.link.dashedPattern=2,a.link.lineWidth=a.config.linkDefaultWidth,a.link.arrowsRadius=a.config.linkArrowsRadius,a.link.shadow=a.config.linkShadow,this.add(a.link),a.tempNodeA.setLocation(e.x,e.y),a.tempNodeZ.setLocation(e.x+20,e.y+20);else if(e.target&&e.target instanceof JTopo.Node&&a.beginNode!==e.target&&"linkShadow"!==e.target.type){var i=e.target;if(null!==i.outLinks)for(var r=0;r<i.outLinks.length;r++)if(i.outLinks[r].nodeZ===a.beginNode||i.outLinks[r].nodeA===a.beginNode)return a.link&&this.remove(a.link),void(a.beginNode=null);if(null!==a.beginNode.outLinks)for(var l=0;l<a.beginNode.outLinks.length;l++)if(a.beginNode.outLinks[l].nodeZ===i)return a.link&&this.remove(a.link),void(a.beginNode=null);var c=[];!function e(t){if(null===t.inLinks)return!1;for(var o=0;o<t.inLinks.length;o++)c.push(t.inLinks[o].nodeA),e(t.inLinks[o].nodeA)}(a.beginNode);for(var d=0;d<c.length;d++)if(c[d]===i)return a.link&&this.remove(a.link),void(a.beginNode=null);var u=void 0;"line"===a.lineType?(u=new JTopo.Link(a.beginNode,i)).lineType="line":"foldLine"===a.lineType?((u=new JTopo.FoldLink(a.beginNode,i)).direction=a.config.linkDirection,u.bundleOffset=a.config.linkOffsetGap,u.lineType="foldLine"):"flexLine"===a.lineType?((u=new JTopo.FlexionalLink(a.beginNode,i)).direction=a.config.linkDirection,u.lineType="flexLine",u.offsetGap=a.config.linkOffsetGap):"curveLine"===a.lineType&&((u=new JTopo.CurveLink(a.beginNode,i)).lineType="curveLine"),u.nodeSrc=a.beginNode.nodeId,u.nodeDst=i.nodeId,"curveLine"!==a.lineType&&(u.arrowsRadius=a.config.arrowsRadius),u.strokeColor=a.config.linkStrokeColor,u.lineWidth=a.config.linkDefaultWidth,u.arrowsRadius=a.config.linkArrowsRadius,this.add(u),a.newLink=u,a.beginNode=null,this.remove(a.link),a.link=null}else a.beginNode=null}else a.link&&this.remove(a.link),a.beginNode=null}),this.scene.mousemove(function(e){!a.isSelectedMode&&a.beginNode&&a.tempNodeZ.setLocation(e.x,e.y),a.tempNodeL.setLocation(e.x,a.tempNodeL.y)}),this.scene.mousedrag(function(e){!a.isSelectedMode&&a.beginNode&&a.tempNodeZ.setLocation(e.x,e.y),a.tempNodeL.setLocation(e.x,a.tempNodeL.y)}),this.stage.click(function(e){0===e.button&&$("div[id$='-menu']").hide()}),this.stage.mouseout(function(e){!a.link||a.isSelectedMode||null!=e.target&&e.target!==a.beginNode&&e.target!==a.link||a.scene.remove(a.link)}),$(document).keydown(function(e){if(e.shiftKey)switch(e.which){case 187:s.utils.scalingBig();break;case 61:s.currentNode instanceof JTopo.Node?(s.utils.saveNodeInitState(),s.utils.scalingBig(),s.utils.saveNodeNewState()):s.utils.scalingBig();break;case 229:s.utils.scalingSmall();break;case 173:s.currentNode instanceof JTopo.Node?(s.utils.saveNodeInitState(),s.utils.scalingSmall(),s.utils.saveNodeNewState()):s.utils.scalingSmall();break;case 70:s.utils.showInFullScreen(s.stage.canvas,"RequestFullScreen");break;case 72:break;case 71:s.utils.showInCenter();break;case 73:s.currentNode instanceof JTopo.Node&&(s.utils.saveNodeInitState(),s.utils.rotateSub(),s.utils.saveNodeNewState());break;case 67:s.utils.cloneSelectedNodes();break;case 80:s.utils.showPic();break;case 82:s.currentNode instanceof JTopo.Node&&s.utils.reMakeNodeAction();break;case 83:s.saveTopology(!0);break;case 85:s.currentNode instanceof JTopo.Node&&(s.utils.saveNodeInitState(),s.utils.rotateAdd(),s.utils.saveNodeNewState());break;case 87:break;case 89:s.utils.clearTopology();break;case 90:s.currentNode instanceof JTopo.Node&&s.utils.cancleNodeAction()}else 46===e.which?s.utils.deleteSelectedNodes():17===e.which&&(a.isSelectedMode=!0)}),$(document).keyup(function(e){if(17===e.which)return a.isSelectedMode=!1,!1})}},r.prototype.drag=function(e,t,o){o||(o="");var n=this;e.ondragstart=function(e){e=e||window.event;var t=$(this).attr("node-type"),n=$(this).attr("node-id"),i=$(this).attr("app-id"),a=($(this).attr("app-name"),"GP"===t?"/static/images/batchRun/init-group.png":"/static/images/init.png");try{e.dataTransfer.setData("text",a+";"+o+";"+t),e.dataTransfer.setData("stepId",n),e.dataTransfer.setData("appId",i)}catch(e){}},t.ondragover=function(e){return e.preventDefault(),!1},t.ondrop=function(e){var t=(e=e||window.event).dataTransfer.getData("text"),o=e.dataTransfer.getData("stepId"),i=e.dataTransfer.getData("appId"),a=void 0,r=void 0;if(t){var s=t.split(";");if(s&&3===s.length){a=s[0],r=s[2];var l=new JTopo.Node;l.fontColor=n.config.nodeFontColor,l.setBound((e.layerX?e.layerX:e.offsetX)-n.scene.translateX-n.config.nodeDefaultWidth/2,(e.layerY?e.layerY:e.offsetY)-n.scene.translateY-n.config.nodeDefaultHeight/2,n.config.nodeDefaultWidth,n.config.nodeDefaultHeight);var c="GP"===r?"/static/images/batchRun/init-group.png":"/static/images/batchRun/init.png";l.setImage(c),l.nodeType=r,l.stepId=o,l.appId=i,l.nodeImage=a,l.textPosition="Middle_Center",l.textOffsetY=-2,n.scene.add(l),n.currentNode=l,n.utils.setNodeCreateListener()}}}};var s=new r("mainControl");s.utils={setNodeCreateListener:function(e){e()},getAllContainers:function(){return s.stage.find("container")},getAllNodes:function(){return s.stage.find("node")},getAllLinks:function(){return s.stage.find("link")},getSelectedNodes:function(){var e=[];return s.scene.selectedElements.forEach(function(t){"node"===t.elementType&&e.push(t)}),e},toMerge:function(){var e=this.getSelectedNodes(),t=new JTopo.Container;t.textPosition="Top_Center",t.fontColor=s.config.nodeFontColor,t.borderColor=s.config.nodeBorderColor,t.borderRadius=s.config.nodeBorderRadius,s.scene.add(t),e.forEach(function(e){t.add(e)})},toSplit:function(){s.currentNode instanceof JTopo.Container&&(s.currentNode.removeAll(),s.scene.remove(s.currentNode))},deleteLine:function(){s.currentLink instanceof JTopo.Link&&(s.scene.remove(s.currentLink),s.currentLink=null,s.lineMenu.hide())},deleteNode:function(e){s.scene.remove(e),s.currentNode=null,s.beginNode=null,s.link&&s.scene.remove(s.link),s.link=null},deleteSelectedNodes:function(){var e=s.scene.selectedElements;if(e&&e.length>0)for(var t=0;t<e.length;t++)this.deleteNode(e[t])},scalingBig:function(){s.stage.zoomOut(s.stage.wheelZoom)},scalingSmall:function(){s.stage.zoomIn(s.stage.wheelZoom)},rotateAdd:function(){s.currentNode instanceof JTopo.Node&&(s.currentNode.rotate+=s.config.nodeRotateValue)},rotateSub:function(){s.currentNode instanceof JTopo.Node&&(s.currentNode.rotate-=s.config.nodeRotateValue)},clearTopology:function(){s.deleteAllNodes()},showPic:function(){s.stage.saveImageInfo()},exportAsImage:function(){s.stage.exportAsImage()},setEditMode:function(){s.stageMode="edit"},setNormalMode:function(){s.stageMode="normal"},cloneNode:function(e){if(e instanceof JTopo.Node){var t=new JTopo.Node;e.serializedProperties.forEach(function(o){t[o]=e[o]}),t.nodeId=generateUUID(),t.alpha=s.config.nodeAlpha,t.strokeColor=s.config.nodeStrokeColor,t.fillColor=s.config.nodeFillColor,t.shadow=s.config.nodeShadow,t.shadowColor=s.config.nodeShadowColor,t.font=s.config.nodeFont,t.fontColor=s.config.nodeFontColor,t.borderRadius=null,t.layout=e.layout,t.selected=!1,t.setLocation(e.x+e.width,e.y+e.height),t.text=e.text,t.setImage(e.image),s.scene.add(t)}},cloneSelectedNodes:function(){var e=this;s.scene.selectedElements.forEach(function(t){"node"===t.elementType&&e.cloneNode(t)})},showInFullScreen:function(e,t){var o=void 0;return["webkit","moz","ms","o",""].forEach(function(n){if(!o){var a=i()(e[n+t]);a+""!="undefined"&&(o="function"===a?e[n+t]():e[n+t])}}),o},showInCenter:function(){s.stage.centerAndZoom()},getContainers:function(){var e=[];return s.stage.childs.forEach(function(t){t.childs.forEach(function(t){"container"===t.elementType&&e.push(t)})}),e},getNodeByKey:function(e,t){var o=null;return s.stage.childs.forEach(function(n){n.childs.forEach(function(n){if("node"===n.elementType&&n[e]===t)return o=n})}),o},cancleNodeAction:function(){if(!(s.currentNode.currStep<=0))for(var e in--s.currentNode.currStep,s.currentNode)"currStep"!==e&&(s.currentNode[e]=s.currentNode.historyStack[s.currentNode.currStep][e])},reMakeNodeAction:function(){if(!(s.currentNode.currStep>=s.currentNode.maxHistoryStep||s.currentNode.currStep>=s.currentNode.historyStack.length-1))for(var e in s.currentNode.currStep++,s.currentNode)"currStep"!==e&&(s.currentNode[e]=s.currentNode.historyStack[s.currentNode.currStep][e])},saveNodeNewState:function(){s.currentNode.historyStack.length>=s.currentNode.maxHistoryStep+1&&s.currentNode.historyStack.shift(),s.currentNode.historyStack.push(JTopo.util.clone(s.currentNode)),s.currentNode.currStep=s.currentNode.historyStack.length-1},saveNodeInitState:function(){s.currentNode.hasInitStateSaved||(s.currentNode.historyStack.push(JTopo.util.clone(s.currentNode)),s.currentNode.hasInitStateSaved=!0)},findNodeAndFlash:function(e){if(e){e=e.trim();var t=s.stage.find('node[text="'+e+'"]');if(t.length>0){var o=t[0];this.unSelectAllNodeExcept(o),o.selected=!0;var n=o.getCenterLocation();s.stage.setCenter(n.x,n.y);!function e(t,o){0!==o?(t.selected=!t.selected,setTimeout(function(){e(t,o-1)},300)):s.utils.unSelectAllNodeExcept(t)}(o,10)}}},unSelectAllNodeExcept:function(e){s.stage.childs.forEach(function(t){t.childs.forEach(function(t){t.nodeId!==e.nodeId&&(t.selected=!1)})})}},t.a=s},mbce:function(e,t,o){var n=o("lktj"),i=o("TcQ7"),a=o("NpIQ").f;e.exports=function(e){return function(t){for(var o,r=i(t),s=n(r),l=s.length,c=0,d=[];l>c;)a.call(r,o=s[c++])&&d.push(e?[o,r[o]]:r[o]);return d}}}});